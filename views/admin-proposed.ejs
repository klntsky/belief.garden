<h1>Review Proposed Belief Cards</h1>
<p><a href="/admin">← Back to Admin Panel</a></p>

<% if (proposedBeliefs.length === 0) { %>
  <p>No proposed belief cards pending review.</p>
<% } else { %>
  <div id="proposals-container">
    <% proposedBeliefs.forEach((proposal, index) => { %>
      <div class="proposal-card" style="border: 1px solid #A55; border-radius: 8px; padding: 20px; margin: 20px 0; background-color: rgba(255, 200, 200, 0.2);">
        <div style="margin-bottom: 15px;">
          <label for="name-<%= proposal.timestamp %>" style="display: block; margin-bottom: 5px; font-weight: bold;">Belief Name:</label>
          <input 
            type="text" 
            id="name-<%= proposal.timestamp %>" 
            class="proposal-field"
            data-proposal-id="<%= proposal.timestamp %>"
            value="<%= proposal.beliefName %>"
            maxlength="100" 
            required
            style="width: 100%; padding: 8px; border: 1px solid #A55; border-radius: 4px; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 15px;">
          <label for="category-<%= proposal.timestamp %>" style="display: block; margin-bottom: 5px; font-weight: bold;">Category:</label>
          <select 
            id="category-<%= proposal.timestamp %>" 
            class="proposal-field"
            data-proposal-id="<%= proposal.timestamp %>"
            required
            style="width: 100%; padding: 8px; border: 1px solid #A55; border-radius: 4px; box-sizing: border-box;">
            <% categories.forEach(cat => { %>
              <option value="<%= cat %>" <%= proposal.category === cat ? 'selected' : '' %>><%= cat %></option>
            <% }); %>
          </select>
        </div>

        <div style="margin-bottom: 15px;">
          <label for="description-<%= proposal.timestamp %>" style="display: block; margin-bottom: 5px; font-weight: bold;">Description:</label>
          <textarea 
            id="description-<%= proposal.timestamp %>" 
            class="proposal-field"
            data-proposal-id="<%= proposal.timestamp %>"
            maxlength="500" 
            rows="5" 
            required
            style="width: 100%; padding: 8px; border: 1px solid #A55; border-radius: 4px; font-family: inherit; box-sizing: border-box;"><%= proposal.description %></textarea>
        </div>

        <div style="margin-bottom: 15px;">
          <label for="additional-prompt-<%= proposal.timestamp %>" style="display: block; margin-bottom: 5px; font-weight: bold;">Additional Image Prompt:</label>
          <textarea 
            id="additional-prompt-<%= proposal.timestamp %>" 
            class="proposal-field"
            data-proposal-id="<%= proposal.timestamp %>"
            maxlength="300" 
            rows="3" 
            placeholder="e.g., image style: use warm colors, PIXAR 3d cartoon style..."
            style="width: 100%; padding: 8px; border: 1px solid #A55; border-radius: 4px; font-family: inherit; box-sizing: border-box;"><%- proposal.additionalPrompt ? proposal.additionalPrompt : '' %></textarea>
          <small style="color: #666;">Optional. Additional styling instructions for image generation. Maximum 300 characters.</small>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Generated Image:</label>
          <div id="image-preview-<%= proposal.timestamp %>" style="margin-bottom: 10px; min-height: 100px; border: 1px solid #A55; border-radius: 4px; padding: 10px; background-color: rgba(255, 255, 255, 0.5); display: none;">
            <img id="preview-img-<%= proposal.timestamp %>" src="" alt="Generated image preview" style="max-width: 100%; max-height: 400px; border-radius: 4px; display: none;">
            <p id="preview-status-<%= proposal.timestamp %>" style="margin: 0; color: #666;"></p>
          </div>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button 
              class="generate-image-btn" 
              data-proposal-id="<%= proposal.timestamp %>"
              style="padding: 10px 20px; background-color: #55A; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Generate Image
            </button>
            <button 
              class="clear-image-btn" 
              data-proposal-id="<%= proposal.timestamp %>"
              style="padding: 10px 20px; background-color: #888; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
              Clear Image
            </button>
          </div>
          <input 
            type="hidden" 
            id="image-url-<%= proposal.timestamp %>" 
            class="image-url-field"
            data-proposal-id="<%= proposal.timestamp %>"
            value="">
        </div>

        <p><strong>Proposed by:</strong> <a href="/<%= proposal.proposedBy %>"><%= proposal.proposedBy %></a></p>
        <p><strong>Submitted:</strong> <span class="timestamp" data-timestamp="<%= proposal.timestamp %>"></span></p>
        
        <div style="margin-top: 15px;">
          <button 
            class="approve-btn" 
            data-proposal-id="<%= proposal.timestamp %>"
            style="padding: 10px 20px; background-color: #5A5; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            Approve
          </button>
          <button 
            class="reject-btn" 
            data-proposal-id="<%= proposal.timestamp %>"
            style="padding: 10px 20px; background-color: #A55; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reject
          </button>
        </div>
      </div>
    <% }); %>
  </div>
<% } %>

<script>
// Format timestamps
document.querySelectorAll('.timestamp').forEach(el => {
  const timestamp = parseInt(el.getAttribute('data-timestamp'));
  const date = new Date(timestamp);
  el.textContent = date.toLocaleString();
});

// Generate Image button handler
document.querySelectorAll('.generate-image-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const proposalId = parseInt(btn.getAttribute('data-proposal-id'));
    const card = btn.closest('.proposal-card');
    
    // Get all field values
    const nameInput = card.querySelector(`#name-${proposalId}`);
    const categoryInput = card.querySelector(`#category-${proposalId}`);
    const descriptionInput = card.querySelector(`#description-${proposalId}`);
    const promptInput = card.querySelector(`#additional-prompt-${proposalId}`);
    const imageUrlInput = card.querySelector(`#image-url-${proposalId}`);
    const previewDiv = card.querySelector(`#image-preview-${proposalId}`);
    const previewImg = card.querySelector(`#preview-img-${proposalId}`);
    const previewStatus = card.querySelector(`#preview-status-${proposalId}`);
    
    const name = nameInput ? nameInput.value.trim() : '';
    const category = categoryInput ? categoryInput.value.trim() : '';
    const description = descriptionInput ? descriptionInput.value.trim() : '';
    const additionalPrompt = promptInput ? promptInput.value.trim() : '';
    
    // Validation
    if (!name || name.length > 100) {
      alert('Name is required and must be 100 characters or less');
      return;
    }
    if (!category) {
      alert('Category is required');
      return;
    }
    if (!description || description.length > 500) {
      alert('Description is required and must be 500 characters or less');
      return;
    }
    if (additionalPrompt.length > 300) {
      alert('Additional prompt cannot exceed 300 characters');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Generating...';
    if (previewDiv) previewDiv.style.display = 'block';
    if (previewStatus) previewStatus.textContent = 'Generating image...';
    if (previewImg) previewImg.style.display = 'none';

    try {
      const response = await fetch('/api/generate-image-url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          proposalId,
          name,
          category,
          description,
          additionalPrompt: additionalPrompt || null
        })
      });

      const data = await response.json();

      if (response.ok && data.imageUrl) {
        if (imageUrlInput) imageUrlInput.value = data.imageUrl;
        if (previewImg) {
          previewImg.src = data.imageUrl;
          previewImg.style.display = 'block';
        }
        if (previewStatus) previewStatus.textContent = 'Image generated successfully!';
        btn.textContent = 'Regenerate Image';
        
        // Show clear button
        const clearBtn = card.querySelector(`.clear-image-btn[data-proposal-id="${proposalId}"]`);
        if (clearBtn) clearBtn.style.display = 'inline-block';
      } else {
        if (previewStatus) previewStatus.textContent = 'Error: ' + (data.error || 'Failed to generate image');
        alert('Error: ' + (data.error || 'Failed to generate image'));
      }
    } catch (error) {
      console.error('Error:', error);
      if (previewStatus) previewStatus.textContent = 'An error occurred while generating the image';
      alert('An error occurred while generating the image');
    } finally {
      btn.disabled = false;
    }
  });
});

// Clear Image button handler
document.querySelectorAll('.clear-image-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const proposalId = parseInt(btn.getAttribute('data-proposal-id'));
    const card = btn.closest('.proposal-card');
    
    const imageUrlInput = card.querySelector(`#image-url-${proposalId}`);
    const previewDiv = card.querySelector(`#image-preview-${proposalId}`);
    const previewImg = card.querySelector(`#preview-img-${proposalId}`);
    const previewStatus = card.querySelector(`#preview-status-${proposalId}`);
    const generateBtn = card.querySelector(`.generate-image-btn[data-proposal-id="${proposalId}"]`);
    
    // Clear the image URL
    if (imageUrlInput) imageUrlInput.value = '';
    
    // Hide preview
    if (previewDiv) previewDiv.style.display = 'none';
    if (previewImg) {
      previewImg.src = '';
      previewImg.style.display = 'none';
    }
    if (previewStatus) previewStatus.textContent = '';
    
    // Reset generate button text
    if (generateBtn) generateBtn.textContent = 'Generate Image';
    
    // Hide clear button
    btn.style.display = 'none';
  });
});

// Approve button handler
document.querySelectorAll('.approve-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const proposalId = parseInt(btn.getAttribute('data-proposal-id'));
    const card = btn.closest('.proposal-card');
    
    // Get all field values
    const nameInput = card.querySelector(`#name-${proposalId}`);
    const categoryInput = card.querySelector(`#category-${proposalId}`);
    const descriptionInput = card.querySelector(`#description-${proposalId}`);
    const promptInput = card.querySelector(`#additional-prompt-${proposalId}`);
    const imageUrlInput = card.querySelector(`#image-url-${proposalId}`);
    
    const name = nameInput ? nameInput.value.trim() : '';
    const category = categoryInput ? categoryInput.value.trim() : '';
    const description = descriptionInput ? descriptionInput.value.trim() : '';
    const additionalPrompt = promptInput ? promptInput.value.trim() : '';
    const imageUrl = imageUrlInput ? imageUrlInput.value.trim() : '';
    
    // Validation
    if (!name || name.length > 100) {
      alert('Name is required and must be 100 characters or less');
      return;
    }
    if (!category) {
      alert('Category is required');
      return;
    }
    if (!description || description.length > 500) {
      alert('Description is required and must be 500 characters or less');
      return;
    }
    if (additionalPrompt.length > 300) {
      alert('Additional prompt cannot exceed 300 characters');
      return;
    }
    
    // Check if this is a new belief (not updating existing)
    const beliefsData = await fetch('/static/beliefs.json').then(r => r.json()).catch(() => ({}));
    const categoryBeliefs = beliefsData[category] || [];
    const beliefExists = categoryBeliefs.some((b) => b.name === name);
    
    // Image is only required for new beliefs
    if (!beliefExists && !imageUrl) {
      alert('Please generate an image before approving. Click "Generate Image" first.');
      return;
    }
    
    if (!confirm('Are you sure you want to approve this belief card? This will download the image and add it to the beliefs list.')) {
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Approving...';

    try {
      const response = await fetch('/api/approve-belief', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          proposalId,
          name,
          category,
          description,
          additionalPrompt: additionalPrompt || null,
          imageUrl
        })
      });

      const data = await response.json();

      if (response.ok) {
        card.style.opacity = '0.5';
        card.innerHTML = '<p style="color: #5A5; font-weight: bold;">✓ Approved! The belief card has been added.</p>';
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        alert('Error: ' + (data.error || 'Failed to approve belief'));
        btn.disabled = false;
        btn.textContent = 'Approve';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while approving the belief');
      btn.disabled = false;
      btn.textContent = 'Approve';
    }
  });
});

// Reject button handler
document.querySelectorAll('.reject-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const proposalId = parseInt(btn.getAttribute('data-proposal-id'));
    const card = btn.closest('.proposal-card');
    
    if (!confirm('Are you sure you want to reject this proposal? This action cannot be undone.')) {
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Rejecting...';

    try {
      const response = await fetch('/api/reject-belief', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ proposalId })
      });

      const data = await response.json();

      if (response.ok) {
        card.style.opacity = '0.5';
        card.innerHTML = '<p style="color: #A55; font-weight: bold;">✗ Rejected</p>';
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        alert('Error: ' + (data.error || 'Failed to reject proposal'));
        btn.disabled = false;
        btn.textContent = 'Reject';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while rejecting the proposal');
      btn.disabled = false;
      btn.textContent = 'Reject';
    }
  });
});
</script>

